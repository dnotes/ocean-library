# Trying to deploy a SvelteKit app to Cloudflare Pages with Functions

***Disclaimer*: I'm still working on understanding exactly how Node bundlers and compilers
do their magic. If you really understand those things, this is probably below your level.**

I think I've figured out how to deploy a SvelteKit app to Cloudflare Pages with Functions.
Cloudflare Pages is nice because they've got a great free tier, everything is prerendered,
and if you need a server path for something they have functions as well. I'd love to put
my mostly static sites up there, but difficulties often arise because Cloudflare Functions
don't run Node and have to run in 10ms or less.

## Errors and warnings:

### Are you trying to bundle for node? You can use "platform: 'node'" to do that, which will remove this error.
```
09:38:43.719	> Using @sveltejs/adapter-cloudflare
09:38:44.866	✘ [ERROR] Could not resolve "punycode"
09:38:44.866
09:38:44.866	    node_modules/markdown-it/lib/index.js:14:27:
09:38:44.867	      14 │ var punycode     = require('punycode');
09:38:44.867	         ╵                            ~~~~~~~~~~
09:38:44.867
09:38:44.867	  The package "punycode" wasn't found on the file system but is built into node.
                Are you trying to bundle for node? You can use "platform: 'node'" to do that,
                which will remove this error.
```

I don't think there is a way to use "platform: 'node'" with Cloudflare, so this error message
really points you in the wrong direction. Yes, there is *some* [Node.js compatibility in
Cloudflare Workers and Functions], but unless you're trying to use one of those ~10 modules,
**the instructions on that page won't help you**. I tried setting the `nodejs_compat` flag and
it did not help (because I wasn't trying to use those modules).

### Pages only supports files up to 26.2 MB in size
```
10:01:55.280	Deploying your site to Cloudflare's global network...
10:02:01.384	Parsed 2 valid header rules.
10:02:02.440
10:02:02.578	✘ [ERROR] Error: Pages only supports files up to 26.2 MB in size
10:02:02.579
10:02:02.579	  _worker.js.map is 91.2 MB in size
```

How do you get a worker file that is 91.2 MB in size? You use Vite's `import.meta.glob`
functionality to import a substantial fraction of the world's religious literature from
Markdown files (for example):

```js
const allContent = import.meta.glob('./content/**/*.md', { as:'raw' })
```

This works, and doesn't run afoul of ["are you trying to bundle for node"], I think because
Vite is converting all those text files into Javascript modules, each containing just one
long string, and those modules are used by all other paths.

However, if you do this in your top-level `+layout.server.js`, all those modules will be
passed to every `+server.js` route throughout your site, including the ones being served
by Cloudflare Functions.

You may think that you can solve this just by using `fs.readFile` to load all your Markdown
files, but then you'll run afoul of "trying to bundle for node". No, the real issue is that
your Cloudflare Function isn't properly isolated from the static content generation.

### Function includes/excludes exceeds _routes.json limits
```
> Using @sveltejs/adapter-cloudflare
  Function includes/excludes exceeds _routes.json limits
  (see https://developers.cloudflare.com/pages/platform/functions/routing/#limits).
  Dropping 1018 exclude rules — this will cause unnecessary function invocations.
```

By default, [@sveltejs/adapter-cloudflare] creates a Function that will run on every route
on your site, but then creates an exception for each path that is prerendered. These are
written to `.svelte-kit/cloudflare/_routes.json`:

```json
{
	"version": 1,
	"description": "Generated by @sveltejs/adapter-cloudflare",
	"include": [
		"/*"
	],
	"exclude": [
		"/_app/*",
		"/favicon.ico",
    // ...
  ]
}
```

If you have 1118 prerendered routes, that's way too many to `exclude`. I haven't tested this,
but I think what it means is that those routes that get dropped from the exclude list might
trigger the Function even though they're supposed to be prerendered.

To avoid this, you can set the routes manually in `svelte.config.js` by passing options for
[@sveltejs/adapter-cloudflare]. I have a set of dynamic routes for database calls:

```js
import adapter from "@sveltejs/adapter-cloudflare";
import { vitePreprocess } from "@sveltejs/kit/vite";

/** @type {import('@sveltejs/kit').Config} */
const config = {
  preprocess: [vitePreprocess({})],

  kit: {
    adapter: adapter({ // add cloudflare routes config here
      routes: {
        include: ['/db/*'],
        exclude: []
      }
    }),
    prerender: { // this is for SvelteKit's prerendering config
      handleMissingId: 'warn',
    },
  },
};

export default config;
```


### Broken links
```
The following pages contain links to /content/acaranga-sutra#fnref65:1, but no element with
\id="fnref65:1" exists on /content/acaranga-sutra - see the `handleMissingId` option in
https://kit.svelte.dev/docs/configuration#prerender for more info:
```

By default, SvelteKit builds will fail when trying to prerender pages with broken internal
links, even if they only go to anchors. You can also set it to `ignore` or `warn`, as in
the example.

```js
    prerender: { // this is for SvelteKit's prerendering config
      handleMissingId: 'warn',
    },
```

## Things I had to learn:

### Turn on prerendering

This is obvious once you know it, but you have to [set up prerendering in SvelteKit];
this means a `+layout.server.js` file that exports the correct variable. Put this at the
top level of your `routes` directory and you should be golden (but don't forget to turn
prerendering off for the routes that should be served by Cloudflare Pages Functions):

```js
export const prerender=true
```

### Isolate Cloudflare Functions

Even after you've properly set the `routes` configuration for [@sveltejs/adapter-cloudflare],
your content generation code could still be including too much in the Functions bundle if
you have added it to high-level `+layout.server.js` files. This may result in errors like
["are you trying to bundle for node"] and ["Pages only supports files up to 26.2 MB"].

One easy way to fix this was to move all my prerendered content routes to a separate directory,
and put all the content generation code in that `+layout.server.ts` file.

```yml
routes:
  +layout.server.ts: ONLY `export const prerender=true`
  +layout.svelte: top-level layout for the app
  +page.svelte: front page for the app
  (content): # the directory for all the content
    +layout.server.ts: all the content generation code
  db:
    query:
      +server.js: server route for db/query, handled by Cloudflare Pages Function
```

### Include missing node packages

It's possible that somewhere in your dependency tree a package depends on a `node` module
that isn't provided by Cloudflare. I ran into this with the `markdown-it` module depending
on `punycode`, and was able to [install the right version of punycode] as a workaround.

```zsh
npm i -D punycode@^1.4.1
```

## Conclusion

Well, I hope I've learned something from this experience! I sure love Cloudflare when it works,
and hopefully next time I'll have the knowledge to be able to deploy what I need to quickly.


[@sveltejs/adapter-cloudflare]:
https://www.npmjs.com/package/@sveltejs/adapter-cloudflare

[broken links]:
#broken-links

["exceeds _routes.json limits"]
#function-includesexcludes-exceeds-_routesjson-limits

["Pages only supports files up to 26.2 MB"]:
#pages-only-supports-files-up-to-262-mb-in-size

["are you trying to bundle for node"]:
#are-you-trying-to-bundle-for-node-you-can-use-platform-node-to-do-that-which-will-remove-this-error

[set up prerendering in SvelteKit]:
https://kit.svelte.dev/docs/page-options#prerender

[Node.js compatibility in Cloudflare Workers and Functions]:
https://developers.cloudflare.com/workers/runtime-apis/nodejs/

[install the right version of punycode]:
https://github.com/markdown-it/markdown-it/pull/513#issuecomment-762966570